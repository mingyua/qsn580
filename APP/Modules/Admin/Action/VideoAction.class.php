<?php/**后台首页控制器*/Class VideoAction extends CommonAction{	Public function index(){		$st=$_GET['title'];		//p($st);		if($st){			$map="title LIKE  '%$st%'";		}else{			$map="id<>0";		}		import('Class.Cate',APP_PATH);		import('Class.Page',APP_PATH);		$cate=M('cate')->where("module='Product'")->order('sort ASC')->select();		 $this->cate=Cate::unlimitedForlevel($cate,'&nbsp;&nbsp;┗━');		$video=M('video');		$count      = $video->where($map)->count();		$Page       = new Page($count,10);		$show       = $Page->show();		$Video=D('VideoRelation')->relation(true)->where($map)->order('id DESC')->limit($Page->firstRow.','.$Page->listRows)->select();		$this->assign('Video',$Video);		$this->assign('page',$show);		$this->display();		}		//添加产品展示页面		Public function add(){	if(IS_POST){ 	import('ORG.Net.UploadFile');	$upload = new UploadFile();// 实例化上传类	$upload->maxSize  = C('FILE_SIZE') ;// 设置附件上传大小	$upload->allowExts  = explode(',',C('FILE_TYPE'));// 设置附件上传类型	$upload->savePath =C('upload_path');// 设置附件上传目录 	$upload->autoSub = true;                      //是否使用子目录保存上传文件  	$upload->subType = 'date';                      //子目录创建方式，默认为hash，可以设置为hash或者date 	$upload->dateFormat = 'Ymd';                     //子目录方式为date的时候指定日期格式  		if(!$upload->upload()) {// 上传错误提示错误信息			$data['image']="";			 }else{// 上传成功 获取上传文件信息			$info =  $upload->getUploadFileInfo();	 }		$upload = M("video"); // 实例化User对象		$data=array(			'kinds'=>$_POST['kinds'],			'title'=>$_POST['title'],			'entitle'=>$_POST['entitle'],			'zhuyan'=>$_POST['zhuyan'],			'daoyan'=>$_POST['daoyan'],			'image'=>substr($info[0]['savepath'].$info[0]['savename'],1),			'tag'=>$_POST['tag'],			'area'=>$_POST['area'],			'year'=>$_POST['year'],			'total'=>$_POST['total'],			'nowji'=>$_POST['nowji'],			'site_url'=>$_POST['site_url'],			'play_url'=>$_POST['play_url'],			'phone_url'=>$_POST['phone_url'],			'contents'=>$_POST['contents'],			'status'=>$_POST['status'],			'hot'=>$_POST['hot'],			'top'=>$_POST['top'],			'hits'=>$_POST['hits'],			'time'=>time()		); // 创建数据对象   		if($upload->add($data)){			$this->success(C('add_ok'),U(GROUP_NAME.'/video/index'));			}else{				$this->error(C('add_error'));				}					}else{		import('Class.Cate',APP_PATH);		$cate=M('cate')->where("module='Product'")->order('sort ASC')->select();		 $this->cate=Cate::unlimitedForlevel($cate,'&nbsp;&nbsp;┗━');		 $this->unit=M('pay')->where("kinds='151'")->order('sort ASC')->select();		 $this->industry=M('select')->where("pid='13'")->order('sort ASC')->select();		 $this->tag=M('select')->where("pid='12'")->order('sort ASC')->select();		$this->attr=M('attr')->where("module='Product' and status='1'")->order('sort ASC')->select();		$this->display();					}	}//编辑产品展示页面	Public function edit(){		if(IS_POST){		 import('ORG.Net.UploadFile');		$upload = new UploadFile();// 实例化上传类		$upload->maxSize  = 3145728 ;// 设置附件上传大小		$upload->allowExts  = array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型		$upload->savePath =  './Uploads/';// 设置附件上传目录		$upload->autoSub = true;                      //是否使用子目录保存上传文件  		$upload->subType = 'date';                      //子目录创建方式，默认为hash，可以设置为hash或者date 		$upload->dateFormat = 'Ymd';                     //子目录方式为date的时候指定日期格式  	 	if(!$upload->upload()) {// 上传错误提示错误信息			$data['image']=$_POST['img'];		 }else{// 上传成功 获取上传文件信息		$info =  $upload->getUploadFileInfo();		 }			$video = M("video"); // 实例化User对象	if($info[0]['savename']){			$image=substr($info[0]['savepath'].$info[0]['savename'],1);				}else{			$image=$_POST['img'];				}		$data=array(			'id'=>$_POST['pid'],			'kinds'=>$_POST['kinds'],			'title'=>$_POST['title'],			'entitle'=>$_POST['entitle'],			'zhuyan'=>$_POST['zhuyan'],			'daoyan'=>$_POST['daoyan'],			'image'=>$image,			'tag'=>$_POST['tag'],			'area'=>$_POST['area'],			'year'=>$_POST['year'],			'total'=>$_POST['total'],			'nowji'=>$_POST['nowji'],			'site_url'=>$_POST['site_url'],			'play_url'=>$_POST['play_url'],			'phone_url'=>$_POST['phone_url'],			'contents'=>$_POST['contents'],			'status'=>$_POST['status'],			'hot'=>$_POST['hot'],			'top'=>$_POST['top'],			'hits'=>$_POST['hits'],			'time'=>time()		); // 创建数据对象							$count=$video->save($data);			if($count !==false){				$this->success(C('edit_ok'),U(GROUP_NAME.'/video/index'));				}	else{					$this->error(C('edit_error'));										}		}else{		import('Class.Cate',APP_PATH);		$cate=M('cate')->where("module='product'")->order('sort ASC')->select();		 $this->cate=Cate::unlimitedForlevel($cate,'&nbsp;&nbsp;┗━');		$id=I('id',0, 'intval');		$_SESSION['p_id']=$id;		$this->imglist=M("photo")->where("p_id='$id'")->select();		$this->id=$id;		$plist=$video=D('VideoRelation')->where("id=$id")->relation(true)->find();		$inid=$plist['industry'];		$this->plist=$plist;		$glist=M("good_attr")->where("pid=$id")->find();		$this->glist=$glist;				 $this->industry=M('select')->where("pid='13'")->order('sort ASC')->select();		 $this->inkinds=M("select")->where("id='$inid'")->find();		 $this->unit=M('pay')->where("kinds='151'")->order('sort ASC')->select();		 $this->tag=M('select')->where("pid='12'")->order('sort ASC')->select();				$this->display();					}	}//AJAX删除图片处理	Public function delimg(){		$id = intval($_GET['id']);		$photo = M("photo"); // 实例化User对象		$photo->where("id=$id")->delete();			}//批量上传图片处理		function uploadImg() {		$id=$_GET['id'];		import('ORG.Net.UploadFile');		$upload = new UploadFile();// 实例化上传类		$upload->maxSize  = 3145728 ;// 设置附件上传大小		$upload->allowExts  = array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型		$savepath='./uploads/'.date('Ymd').'/';		if (!file_exists($savepath)){			mkdir($savepath);		}		$upload->savePath =  $savepath;// 设置附件上传目录		if(!$upload->upload()) {// 上传错误提示错误信息			$this->error($upload->getErrorMsg());		}else{// 上传成功 获取上传文件信息			$info =  $upload->getUploadFileInfo();			// 保存表单数据 包括附件数据			$Photo = M("Photo"); // 实例化User对象			$product=M("product");			$maxid=$product->where("id>0")->order("id desc")->limit("1")->find();			if($id){				$pid=$_GET['id'];			}else{			$pid=$maxid['id']+1;							}			$Photo->create(); // 创建数据对象			$data['p_id']    = $pid;			$data['image'] = substr($info[0]['savepath'], 1) . $info[0]['savename'];			$data['create_time']    = NOW_TIME;			$Photo->add($data); // 写入用户数据到数据库}	}			//产品列表删除操作	Public function del(){		$id = intval($_GET['id']);		$video = M("video"); // 实例化User对象		if($video->where("id='$id'")->delete()){					echo 1;				}else{					echo 0;				}		}	//产品列表全选删除操作	Public function delall(){				$id =$_POST['id'];		$name=$this->getActionName();//获取模型名称		$model=D($name);//获取当前模块的操作对象		if(!empty($model)){			$pk=$model->getpk();//获取传递参数（以ID删除）			if(!empty($id)){				$condition=array($pk=>array('IN',$id));								if(false!==$model->where($condition)->delete()){					echo 1;				}else{					echo 0;				}			}					}					}	Public function status(){		$id=$_POST['id'];		$video = M("video"); // 实例化User对象		$zt=$video->where("id='$id'")->find();		if($zt['status']==1){		$data['status'] =0;		}else{		$data['status'] =1;		}		$data['time']=time();		$video->where("id='$id'")->save($data);		if($video){			echo 1;		}else{			echo 0;		}	}	Public function top(){		$id=$_POST['id'];		$video = M("video"); // 实例化User对象		$zt=$video->where("id='$id'")->find();		if($zt['top']==1){		$data['top'] =0;		}else{		$data['top'] =1;		}		$video->where("id='$id'")->save($data);		if($video){			echo 1;		}else{			echo 0;		}	}	Public function changeen(){		import('Class.Pinyin',APP_PATH);		$pinyin =new Pinyin(); 		$str =$_POST['str']; 		echo $pinyin->strtopin($str,1); //首字母		//echo $pinyin->strtopin($str);// 全拼	}}?>